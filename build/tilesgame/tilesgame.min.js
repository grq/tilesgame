/*! Tilesgame v1.0.0, 2015 !*/
var Tilesgame={RenderScorePattern:"{score}",RenderScoreSeparator:"^",getRenderScoreText:function(){var e=this;return[e.RenderScoreSeparator,e.RenderScorePattern,e.RenderScoreSeparator].join("")},Direction:{Left:37,Up:38,Right:39,Down:40},ScoreBoardButton:{ShowHideWeight:1,Restart:2,ShowHideImages:4},Cls:{container:"tilesgame-container",scoreboard:"tilesgame-scoreboard",gamefield:"tilesgame-game-field",fieldline:"tilesgame-field-line",tilesContainer:"tilesgame-tile-container",fieldCell:"tilesgame-field-cell",hideTileWeight:"tilesgame-setting-no-weight",settingsContainer:"tilesgame-game-settings",scoreText:"tilesgame-score-txt",scoreValue:"tilesgame-score",messageMask:"tilesgame-msg-mask",messageMaskInCnt:"tilesgame-mask-in-cnt",messageBox:"tilesgame-msg-box",message:"tilesgame-message",messageSmall:"tilesgame-lose-msg-small",messageScore:"tilesgame-lose-msg-score",buttonRestart:"tilesgame-game-over-restart-btn",messageHolder:"tilesgame-msg-holder",tile:"tilesgame-game-tile",tileWeight:"tilesgame-tile-weight",noImages:"tilesgame-setting-noimages"},inheritBase:function(e){e.prototype=new Tilesgame.Base}};Tilesgame.defaultOptions={startTilesgameCount:2,fieldSize:{x:4,y:4},showWeight:!0,showTryAgain:!1,showScoreBoard:!0,showBestScore:!0,useImages:!1,menuButtons:Tilesgame.ScoreBoardButton.ShowHideWeight|Tilesgame.ScoreBoardButton.Restart,fullScreenMessages:!1,gameOverTitle:"GAME OVER!",gameOverText:"Your score is {score}, try again!",tryAgainText:"Try again",newBestScoreText:"New Best Score!",imgFolder:"",gameOverImg:"",bestScoreImg:"",tilesStyle:{2:{font:"",bg:"33CCCC",img:""},4:{font:"",bg:"3399CC",img:""},8:{font:"",bg:"FF6666",img:""},16:{font:"",bg:"FF6600",img:""},32:{font:"",bg:"FF3366",img:""},64:{font:"",bg:"FF0000",img:""},128:{font:"",bg:"CC6666",img:""},256:{font:"",bg:"CC6600",img:""},512:{font:"",bg:"CC3366",img:""},1024:{font:"",bg:"336666",img:""},2048:{font:"",bg:"336600",img:""},4096:{font:"",bg:"CC3300",img:""},8192:{font:"",bg:"333366",img:""},"default":{font:"FFF",bg:"0066CC",img:""}}},Tilesgame.Base=function(){this.events={}},$.extend(Tilesgame.Base.prototype,{on:function(e,t,i){var s=this.events;s[e]||(s[e]=[]),i&&(t=t.bind(i)),s[e].push(t)},fire:function(e){var t=this.events,i=Array.prototype.slice.call(arguments);if(t[e])for(var s=t[e].length;s--;)t[e][s].apply(this,i)}}),Tilesgame.App=function(e,t){var i=this;i["private"]={container:e,options:!1,gameField:!1,gameScore:!1,gameMessanger:!1},i["private"].options=$.extend(!0,Tilesgame.defaultOptions,t)},Tilesgame.inheritBase(Tilesgame.App),$.extend(Tilesgame.App.prototype,{start:function(){var e=this;if(!e["private"].container)throw"Container is not defined";e.init(),e.render()},restart:function(){var e=this["private"];e.gameMessanger&&e.gameMessanger.hide(),e.gameField&&e.gameField.restart(),e.gameScore&&e.gameScore.restart()},init:function(){var e=this,t=e["private"];t.gameMessanger=new Tilesgame.ScreenMessanger(t.container,e.getScreenMessangerOptions()),t.gameMessanger.on("restart",e.restart,e),t.gameScore=new Tilesgame.Scoreboard(t.container,e.getScoreboardOptions()),t.gameScore.on("restart",e.restart,e),t.gameScore.on("bestscore",t.gameMessanger.showBestScore,t.gameMessanger),t.gameField=new Tilesgame.Field(t.container,e.getFieldOptions()),t.gameField.on("gameover",e.onGameOver,e)},getScoreboardOptions:function(){var e=this["private"].options;return{visible:e.showScoreBoard,showBestScore:e.showBestScore,buttons:e.menuButtons,showWeight:e.showWeight,useImages:e.useImages}},getFieldOptions:function(){var e=this["private"].options;return{startTilesgameCount:e.startTilesgameCount,size:e.fieldSize,tilesStyle:e.tilesStyle,imgFolder:e.imgFolder}},getScreenMessangerOptions:function(){var e=this["private"].options;return{fullScreenMessages:e.fullScreenMessages,showTryAgain:e.showTryAgain,gameOverTitle:e.gameOverTitle,gameOverText:e.gameOverText,tryAgainText:e.tryAgainText,newBestScoreText:e.newBestScoreText,imgFolder:e.imgFolder,gameOverImg:e.gameOverImg,bestScoreImg:e.bestScoreImg}},render:function(){var e=this["private"];e.container.addClass(Tilesgame.Cls.container),e.gameScore.render(),e.gameField.render()},onResize:function(){var e=this["private"];e.gameField&&e.gameField.onResize(),e.gameMessanger&&e.gameMessanger.onResize()},onGameOver:function(){var e=this["private"];e.gameMessanger.showGameOver(e.gameScore.getScore())},move:function(e){var t=this["private"],i=function(e){t.gameScore.addScore(e)};t.gameField.move(e,i)}}),Tilesgame.Field=function(e,t){this["private"]={parent:e,container:!1,fieldCells:[],options:{},allowMove:!0,tileContainer:!1},this["private"].options=$.extend(this.defaultOptions,t)},Tilesgame.inheritBase(Tilesgame.Field),$.extend(Tilesgame.Field.prototype,{restart:function(){for(var e=this,t=Array.prototype.concat.apply([],e["private"].fieldCells),i=t.length;i--;)t[i].hasTile()&&t[i].deleteTile();e["private"].allowMove=!0,e.createDefaultTilesgame()},getAllAvailableFieldCells:function(){for(var e=this["private"],t=[],i=0;i<e.options.size.x;i++)for(var s=0;s<e.options.size.y;s++)e.fieldCells[i][s].hasTile()||t.push(e.fieldCells[i][s]);return t},getAvailableFieldCell:function(){var e=this.getAllAvailableFieldCells(),t=Math.floor(Math.random()*e.length);return e[t]},createTile:function(){var e=this;return e.getAvailableFieldCell().createTile(e["private"].tileContainer)},mergeTilesgame:function(e,t){return t.getTile().increaseWeight(e.deleteTile(t))},moveTile:function(e,t){var i=t.setTile(e.getTile());return e.removeTile(),i},isGameOver:function(){var e,t,i,s=this["private"];if(!this.getAllAvailableFieldCells().length){for(t=s.options.size.y;t--;)for(e=!1,i=s.options.size.x;i--;){if(e==s.fieldCells[t][i].getTile().getWeight())return!1;e=s.fieldCells[t][i].getTile().getWeight()}for(i=s.options.size.y;i--;)for(e=!1,t=s.options.size.x;t--;){if(e==s.fieldCells[t][i].getTile().getWeight())return!1;e=s.fieldCells[t][i].getTile().getWeight()}return!0}return!1},render:function(){var e,t,i=this,s=i["private"];if(!s.parent)throw"Tilesgame: Game field parent is not defined";for(s.container=$("<div/>",{"class":Tilesgame.Cls.gamefield}).appendTo(s.parent),s.tileContainer=$("<div/>",{"class":Tilesgame.Cls.tilesContainer}).appendTo(s.container),e=0;e<s.options.size.x;e++)for(gameLine=$("<div/>",{"class":Tilesgame.Cls.fieldline}).appendTo(s.container),s.fieldCells[e]=[],t=0;t<s.options.size.y;t++)s.fieldCells[e][t]=new Tilesgame.FieldCell(i.getFieldCellOptions()),s.fieldCells[e][t].render(gameLine);setTimeout(function(){i.createDefaultTilesgame()},150)},getFieldCellOptions:function(){var e=this["private"].options;return{tilesStyle:e.tilesStyle,imgFolder:e.imgFolder}},createDefaultTilesgame:function(){for(var e=this,t=e["private"].options.startTilesgameCount;t--;)e.createTile()},move:function(e,t){var i=this;i["private"].allowMove&&(i["private"].allowMove=!1,i.doMove(e,t))},doMove:function(e,t){var i,s,r,a,o,n,l,g,c=this,m=[],p=c["private"].fieldCells,h=0,d=c.getIterator(e);for(c["private"].allowMove=!1,i=0;i<d.length;i++)for(l=[],g=!1,s=0;s<d[i].length;s++)r=d[i][s].x,a=d[i][s].y,p[r][a].hasTile()?g&&p[r][a].getTile().getWeight()==g.getTile().getWeight()?(n=c.mergeTilesgame(p[r][a],g),m.push(n.deferred),h+=n.weight,l.push(p[r][a]),g=!1):l.length>0?(o=l.shift(),m.push(c.moveTile(p[r][a],o)),l.push(p[r][a]),g=o):g=p[r][a]:l.push(p[r][a]);$.when.apply($,m).then(function(){var e=!!m.length;c.afterMoveDone(e),t(h)})},afterMoveDone:function(e){var t=this;e?$.when(t.createTile().promise()).then(function(){t.isGameOver()?t.fire("gameover"):t["private"].allowMove=!0}):t["private"].allowMove=!0},onResize:function(){for(var e=Array.prototype.concat.apply([],this["private"].fieldCells),t=e.length;t--;)e[t].hasTile()&&e[t].getTile().onResize()},getIterator:function(e){var t=this,i=this["private"];switch(e){case Tilesgame.Direction.Left:return t.getLeftIterator(i.options.size.x,i.options.size.y);case Tilesgame.Direction.Up:return t.getUpIterator(i.options.size.x,i.options.size.y);case Tilesgame.Direction.Right:return t.getRightIterator(i.options.size.x,i.options.size.y);case Tilesgame.Direction.Down:return t.getDownIterator(i.options.size.x,i.options.size.y)}},getLeftIterator:function(e,t){for(var i,s=[],r=0;e>r;r++){i=[];for(var a=0;t>a;a++)i.push({x:r,y:a});s.push(i)}return s},getUpIterator:function(e,t){for(var i,s=[],r=0;t>r;r++){i=[];for(var a=0;e>a;a++)i.push({x:a,y:r});s.push(i)}return s},getRightIterator:function(e,t){for(var i,s=[],r=0;e>r;r++){i=[];for(var a=t;a--;)i.push({x:r,y:a});s.push(i)}return s},getDownIterator:function(e,t){for(var i,s=[],r=0;t>r;r++){i=[];for(var a=e;a--;)i.push({x:a,y:r});s.push(i)}return s}}),Tilesgame.FieldCell=function(e){var t=this;t["private"]={el:!1,currentTile:!1,options:e},$.extend(t["private"].options,e)},$.extend(Tilesgame.FieldCell.prototype,{getEl:function(){return this["private"].el},hasTile:function(){return!!this["private"].currentTile},getTile:function(){return this["private"].currentTile},setTile:function(e,t){return this["private"].currentTile=e,this["private"].currentTile.setFieldCell(this["private"].el,t)},createTile:function(e){var t=this;return t.setTile(new Tilesgame.Tile(e,t.getTileOptions()))},removeTile:function(){this["private"].currentTile=!1},deleteTile:function(e){var t=this["private"].currentTile.destroy(e);return delete this["private"].currentTile,this["private"].currentTile=!1,t},getTileOptions:function(){var e=this["private"].options;return{tilesStyle:e.tilesStyle,imgFolder:e.imgFolder}},render:function(e){var t=this["private"];t.el=$("<div/>",{"class":Tilesgame.Cls.fieldCell}),t.el.appendTo(e)}}),Tilesgame.Scoreboard=function(e,t){this["private"]={parent:e,container:!1,totalScore:0,bestScore:!1,scoreEl:!1,bestScoreEl:!1,settingsEl:!1,options:{},settings:{showTileWeight:{el:!1,state:t.showWeight,showTxt:"Show tile weight",hideTxt:"Hide tile weight"},restart:{el:!1},showHideImages:{el:!1,state:t.useImages,showTxt:"Use images",hideTxt:"Disable images"}}},$.extend(this["private"].options,t)},Tilesgame.inheritBase(Tilesgame.Scoreboard),$.extend(Tilesgame.Scoreboard.prototype,{storageBestScoreKey:"SIDATRON_BEST_SCORE",restart:function(){var e=this,t=e["private"];t.newBestScore=!1,t.totalScore=0,t.bestScore="NA",localStorage&&(localStorage[e.storageBestScoreKey]||(localStorage[e.storageBestScoreKey]=0),t.bestScore=localStorage[e.storageBestScoreKey]),e.updateScore()},getEl:function(){return this["private"].el},getScore:function(){return this["private"].totalScore},addScore:function(e){var t=this;t["private"].totalScore+=e,t.checkBestScore(),t.updateScore()},checkBestScore:function(){var e=this,t=e["private"];localStorage&&t.bestScore<t.totalScore&&(t.bestScore=t.totalScore,localStorage[this.storageBestScoreKey]=t.bestScore,t.options.showBestScore&&!t.newBestScore&&(t.newBestScore=!0,e.fire("bestscore")))},render:function(){var e=this,t=e["private"];t.options.visible&&(t.container=$("<div/>",{"class":Tilesgame.Cls.scoreboard}).appendTo(t.parent),t.options.showBestScore&&($("<span/>",{"class":Tilesgame.Cls.scoreText}).html("BEST:").appendTo(t.container),t.bestScoreEl=$("<span/>",{"class":Tilesgame.Cls.scoreValue}).appendTo(t.container)),$("<span/>",{"class":Tilesgame.Cls.scoreText}).html("SCORE:").appendTo(t.container),t.scoreEl=$("<span/>",{"class":Tilesgame.Cls.scoreValue}),t.scoreEl.appendTo(t.container),e.renderSettingsMenu(t.container)),e.restart()},renderSettingsMenu:function(e){var t=this,i=t["private"];i.settingsEl=$("<div/>",{"class":Tilesgame.Cls.settingsContainer}).appendTo(e),(i.options.buttons&Tilesgame.ScoreBoardButton.ShowHideWeight)>0&&t.initTileWeight(),(i.options.buttons&Tilesgame.ScoreBoardButton.Restart)>0&&t.renderRestartBtn(),(i.options.buttons&Tilesgame.ScoreBoardButton.ShowHideImages)>0&&t.initImageSwitcher()},initTileWeight:function(){var e=this,t=e["private"];t.settings.showTileWeight.el=$("<span/>").appendTo(t.settingsEl).click(function(){e.toggleTileWeight()}),e.toggleTileWeight(!0)},toggleTileWeight:function(e){var t=this,i=t["private"],s=i.settings.showTileWeight,r=$(i.parent);e||(s.state=!s.state),s.el.text(s.state?s.hideTxt:s.showTxt),r.toggleClass(Tilesgame.Cls.hideTileWeight,!s.state)},renderRestartBtn:function(){var e=this,t=e["private"];t.settings.restart.el=$("<span/>").appendTo(t.settingsEl),t.settings.restart.el.html("Restart"),t.settings.restart.el.click(function(){e.fire("restart")})},initImageSwitcher:function(){var e=this,t=e["private"];t.settings.showHideImages.el=$("<span/>").appendTo(t.settingsEl).click(function(){e.toggleImages()}).html("asdd"),e.toggleImages(!0)},toggleImages:function(e){var t=this,i=t["private"],s=i.settings.showHideImages;e||(s.state=!s.state),s.el.text(s.state?s.hideTxt:s.showTxt),$("body").toggleClass(Tilesgame.Cls.noImages,!s.state)},updateScore:function(){var e=this["private"];e.options.visible&&(e.scoreEl.html(e.totalScore),e.options.showBestScore&&e.bestScoreEl.html(e.bestScore))}}),Tilesgame.ScreenMessanger=function(e,t){this["private"]={options:{},parent:e,score:"NA",durationOver:1e3,durationHide:500,durationBestScore:500},$.extend(this["private"].options,t),this.init()},Tilesgame.inheritBase(Tilesgame.ScreenMessanger),$.extend(Tilesgame.ScreenMessanger.prototype,{Message:{GameOver:1,NewBestScore:2},onResize:function(){this.resize()},showGameOver:function(e){var t=this;t["private"].score=e,t.showMessage(t.Message.GameOver,t["private"].durationOver)},showBestScore:function(){var e=this;e.showMessage(e.Message.NewBestScore,e["private"].durationBestScore),e.hide()},hide:function(){var e=this,t=e["private"];t.maskEl.animate({opacity:"0"},t.durationHide,function(){t.maskEl.hide()}),t.msgBoxEl.animate({opacity:"0"},t.durationHide,function(){t.msgBoxEl.hide()}),t.msgEl.animate({opacity:"0"},t.durationHide,function(){t.gameOverEl.appendTo(t.msgHolder),t.bestScoreEl.appendTo(t.msgHolder),t.msgEl.hide()})},showMessage:function(e,t){var i,s=this,r=s["private"];switch(r.maskEl.css({opacity:"0"}),r.maskEl.animate({opacity:"0.6"},t),r.maskEl.show(),r.msgBoxEl.css({opacity:"0"}),r.msgBoxEl.animate({opacity:"0.6"},t),r.msgBoxEl.show(),r.msgEl.css({opacity:"0"}),r.msgEl.animate({opacity:"1"},t),r.msgEl.show(),e){case s.Message.GameOver:r.gameOverEl.appendTo(r.msgEl),i=r.options.gameOverImg,r.scoreEl&&r.scoreEl.html(r.score);break;case s.Message.NewBestScore:r.bestScoreEl.appendTo(r.msgEl),i=r.options.bestScoreImg}i&&r.maskEl.css({"background-image":["url(",r.options.imgFolder,i,")"].join("")}),s.resize()},resize:function(){var e,t,i=this["private"];i.options.fullScreenMessages?i.maskEl.css({height:"100%",width:"100%",top:"0px",left:"0px"}):(i.maskEl.height(i.parent.height()),i.maskEl.width(i.parent.width()),i.maskEl.css(i.parent.offset())),i.maskEl.toggleClass(Tilesgame.Cls.messageMaskInCnt,!i.options.fullScreenMessages),i.msgEl.offset(i.maskEl.offset()),e=(i.maskEl.height()-i.msgEl.outerHeight())/2,t=(i.maskEl.width()-i.msgEl.outerWidth())/2,e=i.options.fullScreenMessages?e:i.msgEl.offset().top+e,t=i.options.fullScreenMessages?t:i.msgEl.offset().left+t,i.msgEl.css({top:e,left:t}),i.msgBoxEl.css(i.msgEl.offset()),i.msgBoxEl.height(i.msgEl.outerHeight()),i.msgBoxEl.width(i.msgEl.outerWidth())},init:function(){var e=this,t=e["private"];t.msgHolder||(t.msgHolder=$("<div/>",{"class":Tilesgame.Cls.messageHolder}).appendTo(t.parent)),t.maskEl||(t.maskEl=$("<div/>",{"class":Tilesgame.Cls.messageMask}).appendTo(t.parent)),t.msgBoxEl||(t.msgBoxEl=$("<div/>",{"class":Tilesgame.Cls.messageBox}).appendTo(t.parent)),t.msgEl||(t.msgEl=$("<div/>",{"class":Tilesgame.Cls.message}).appendTo(t.parent)),t.gameOverEl||(t.gameOverEl=$("<div/>").appendTo(t.msgHolder),e.renderGameOverEl()),t.bestScoreEl||(t.bestScoreEl=$("<div/>").html(t.options.newBestScoreText).appendTo(t.msgHolder))},renderGameOverEl:function(){var e,t=this,i=t["private"];i.gameOverEl.html(i.options.gameOverTitle),$("<br/>").appendTo(i.gameOverEl),e=$("<span/>",{"class":Tilesgame.Cls.messageSmall}).appendTo(i.gameOverEl),t.renderGameOverMessage(e),i.options.showTryAgain&&t.renderRestartBtn()},renderGameOverMessage:function(e){var t,i=this["private"],s=i.options.gameOverText,r=s.split(Tilesgame.RenderScoreSeparator);for(t=0;t<r.length;t++)r[t]==Tilesgame.RenderScorePattern?i.scoreEl=$("<span/>",{"class":Tilesgame.Cls.messageScore}).appendTo(e):e.append(r[t])},renderRestartBtn:function(){var e,t,i=this,s=i["private"];e=$("<div/>",{"class":Tilesgame.Cls.buttonRestart}).appendTo(s.gameOverEl),t=$("<span/>").html(s.options.tryAgainText).appendTo(e),t.click(function(){i.fire("restart")})}}),Tilesgame.Tile=function(e,t){var i=this;i["private"]={weight:!1,el:!1,weightEl:!1,cell:!1,rendered:!1,container:e,options:{}},$.extend(i["private"].options,t),i["private"].weight=i.getRandomWeight()},$.extend(Tilesgame.Tile.prototype,{getRandomWeight:function(){return 2*(Math.floor(2*Math.random())+1)},setFieldCell:function(e){var t=this,i=$.Deferred();return t["private"].cell=e,t["private"].rendered?t.animateMove(i):t.render(i),i.promise()},animateIncreaseWeight:function(e){var t=this["private"].el,i=80,s=20,r=t.height(),a=t.width(),o={height:r+s,width:a+s,"margin-left":s/2*-1,"margin-top":s/2*-1},n={height:r,width:a,"margin-left":0,"margin-top":0};t.css({"z-index":2}),t.animate(o,i,function(){t.animate(n,i,function(){t.css({"z-index":1}),e.resolve()})})},animateCreation:function(e){var t=this["private"].el,i=100,s=t.height(),r=t.width(),a={height:0,width:0,"margin-left":s/2,"margin-top":s/2},o={height:s,width:r,"margin-left":0,"margin-top":0};t.css({"z-index":3}),t.css(a),t.animate(o,i,function(){t.css({"z-index":1}),e.resolve()})},animateMove:function(e,t){var i=100;this["private"].el.animate(this["private"].cell.offset(),t||i,function(){e&&e.resolve()})},getWeight:function(){return this["private"].weight},increaseWeight:function(e){var t=this,i=$.Deferred();return this["private"].weight*=2,$.when(e).then(function(){t.printWeight(),t.animateIncreaseWeight(i)}),{deferred:i.promise(),weight:this["private"].weight}},printWeight:function(){var e=this["private"],t={},i=e.options.tilesStyle[e.weight],s=e.options.tilesStyle["default"];e.weightEl.html(e.weight),i||(i=s),t.color=["#",i.font?i.font:s.font].join(""),t["background-color"]=["#",i.bg?i.bg:s.bg].join(""),t["background-image"]=["url(",e.options.imgFolder,i.img?i.img:s.img,")"].join(""),e.el.css(t)},render:function(e){var t=this,i=t["private"];i.el=$("<div/>",{"class":Tilesgame.Cls.tile}),i.weightEl=$("<div/>",{"class":Tilesgame.Cls.tileWeight}).appendTo(i.el),i.el.css(i.cell.offset()),i.el.appendTo(i.container),t.printWeight(),t.animateCreation(e),i.rendered=!0},onResize:function(){this["private"].el.css(this["private"].cell.offset())},destroy:function(e){var t=$.Deferred(),i=this,s=i["private"];return $.when(t.promise()).then(function(){s.el.detach()}),e?(s.cell=e.getEl(),i.animateMove(t)):s.el.detach(),t}}),jQuery&&(jQuery.fn.tilesgame=function(e){for(var t,i=[],s=this,r=s.length;r--;)t=new Tilesgame.App($(s[r]),e),t.start(),i.push(t);return $(document).keydown(function(e){if(e.which>=Tilesgame.Direction.Left&&e.which<=Tilesgame.Direction.Down){for(var t=i.length;t--;)i[t].move(e.which);e.preventDefault()}}),$(window).resize(function(){for(var e=i.length;e--;)i[e].onResize()}),i});